name: Claude Batch Trigger

on:
  schedule:
    # å¤œé–“ï¼ˆæ—¥æœ¬æ™‚é–“22:00-06:00ï¼‰ã®30åˆ†æ¯ã«å®Ÿè¡Œ
    # UTCæ™‚é–“ã§13:00-21:00ï¼ˆJSTã®22:00-06:00ï¼‰
    - cron: '0,30 13-23 * * *'  # UTC 13:00-23:30 (JST 22:00-08:30)
    - cron: '0,30 0-20 * * *'   # UTC 00:00-20:30 (JST 09:00-05:30)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ
    inputs:
      dry_run:
        description: 'Dry run mode (only show which issue would be processed)'
        required: false
        default: 'false'
        type: boolean

jobs:
  trigger-claude:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find highest priority issue
        id: find_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ã®å®šç¾©ï¼ˆé«˜ã„é †ï¼‰
            const priorityOrder = [
              'Priority: Critical',
              'Priority: High', 
              'Priority: Medium',
              'Priority: Low'
            ];
            
            console.log('=== Claude Batch Trigger Starting ===');
            console.log(`Current time: ${new Date().toISOString()}`);
            
            // batch-readyãƒ©ãƒ™ãƒ«ã‚’æŒã¤ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã‚’å–å¾—
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'batch-ready',
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${issues.data.length} batch-ready issues`);
            
            // å‡¦ç†æ¸ˆã¿ã¾ãŸã¯Claudeå¿œç­”æ¸ˆã¿ã®Issueã‚’é™¤å¤–
            const unprocessedIssues = [];
            for (const issue of issues.data) {
              // batch-processedãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
              if (issue.labels.some(label => label.name === 'batch-processed')) {
                console.log(`Issue #${issue.number} already has batch-processed label, skipping`);
                continue;
              }
              
              // Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              
              // @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              const hasClaudeMention = comments.data.some(comment => 
                comment.body && comment.body.includes('@claude')
              );
              
              if (hasClaudeMention) {
                console.log(`Issue #${issue.number} already has @claude mention, skipping`);
                continue;
              }
              
              unprocessedIssues.push(issue);
            }
            
            console.log(`Found ${unprocessedIssues.length} unprocessed issues`);
            
            if (unprocessedIssues.length === 0) {
              console.log('No unprocessed batch-ready issues found');
              core.setOutput('has_issue', 'false');
              return;
            }
            
            // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
            unprocessedIssues.sort((a, b) => {
              const getPriority = (issue) => {
                for (let i = 0; i < priorityOrder.length; i++) {
                  if (issue.labels.some(label => label.name === priorityOrder[i])) {
                    return i;
                  }
                }
                return priorityOrder.length; // å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆã¯æœ€ä½å„ªå…ˆåº¦
              };
              
              return getPriority(a) - getPriority(b);
            });
            
            // æœ€å„ªå…ˆã®Issueã‚’é¸æŠ
            const selectedIssue = unprocessedIssues[0];
            const priority = selectedIssue.labels.find(label => 
              priorityOrder.includes(label.name)
            )?.name || 'No priority';
            
            console.log(`Selected issue #${selectedIssue.number}: ${selectedIssue.title}`);
            console.log(`Priority: ${priority}`);
            console.log(`Labels: ${selectedIssue.labels.map(l => l.name).join(', ')}`);
            
            core.setOutput('has_issue', 'true');
            core.setOutput('issue_number', selectedIssue.number.toString());
            core.setOutput('issue_title', selectedIssue.title);
            core.setOutput('issue_priority', priority);
            core.setOutput('issue_url', selectedIssue.html_url);

      - name: Trigger Claude with comment
        if: steps.find_issue.outputs.has_issue == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ steps.find_issue.outputs.issue_number }}');
            const issueTitle = '${{ steps.find_issue.outputs.issue_title }}';
            const issuePriority = '${{ steps.find_issue.outputs.issue_priority }}';
            
            console.log(`Triggering Claude for issue #${issueNumber}...`);
            
            // @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `@claude ã“ã®Issueã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚

**ãƒãƒƒãƒå‡¦ç†å®Ÿè¡Œæƒ…å ±**
- å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}
- å„ªå…ˆåº¦: ${issuePriority}
- å‡¦ç†ãƒ¢ãƒ¼ãƒ‰: è‡ªå‹•ãƒãƒƒãƒå‡¦ç†

ã“ã®è‡ªå‹•ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚Šã€å„ªå…ˆåº¦ã®é«˜ã„Issueã‹ã‚‰é †ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
æ·±å¤œã®æ™‚é–“ã‚’æ´»ç”¨ã—ã¦ã€åŠ¹ç‡çš„ã«ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã•ã›ã¾ã—ã‚‡ã†ã€‚`
            });
            
            console.log(`Posted @claude comment on issue #${issueNumber}`);
            console.log(`Comment URL: ${comment.data.html_url}`);
            
            // å‡¦ç†æ¸ˆã¿ãƒãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ batch-processed ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['batch-processed']
              });
              console.log('Added batch-processed label');
            } catch (error) {
              console.log('Note: batch-processed label may not exist yet');
              // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'batch-processed',
                  color: '5319e7',
                  description: 'Claude batch processing has been triggered'
                });
                console.log('Created batch-processed label');
                
                // å†åº¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['batch-processed']
                });
              } catch (createError) {
                console.error('Failed to create label:', createError.message);
              }
            }

      - name: Summary
        if: always()
        run: |
          echo "=== Claude Batch Trigger Summary ==="
          echo "Execution time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Execution time (JST): $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
          echo ""
          if [ "${{ steps.find_issue.outputs.has_issue }}" == "true" ]; then
            echo "âœ… Issue selected for processing:"
            echo "   Number: #${{ steps.find_issue.outputs.issue_number }}"
            echo "   Title: ${{ steps.find_issue.outputs.issue_title }}"
            echo "   Priority: ${{ steps.find_issue.outputs.issue_priority }}"
            echo "   URL: ${{ steps.find_issue.outputs.issue_url }}"
            echo ""
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "ğŸ” Mode: DRY RUN (no actual processing)"
            else
              echo "ğŸš€ Mode: PROCESSED - Claude triggered"
            fi
          else
            echo "âŒ No unprocessed batch-ready issues found"
          fi
          echo "===================================="